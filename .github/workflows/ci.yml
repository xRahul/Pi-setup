name: CI

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Docker Compose
        run: docker compose config -q
        env:
          # Set dummy values for required env vars to pass config check
          TAILSCALE_AUTH_KEY: "dummy"
          TAILSCALE_PATH: "./tailscale"
          PIHOLE__WEBPASSWORD: "dummy"
          DEFAULT_TZ: "UTC"
          PIHOLE_ETC_PATH: "./pihole/etc"
          PIHOLE_ETC_DNSMASQ_PATH: "./pihole/dnsmasq"
          CLOUDFLARE_API_TOKEN: "dummy"
          CADDY_SITE_PATH: "./caddy/site"
          CADDY_DATA_PATH: "./caddy/data"
          CADDY_CONFIG_PATH: "./caddy/config"
          PAPERLESS_NGX_DATA_PATH: "./paperless/data"
          PAPERLESS_NGX_MEDIA_PATH: "./paperless/media"
          PAPERLESS_NGX_EXPORT_PATH: "./paperless/export"
          PAPERLESS_NGX_CONSUME_PATH: "./paperless/consume"
          PAPERLESS_NGX_URL: "http://localhost"
          PAPERLESS_NGX_SECRET_KEY: "dummy"
          N8N_DATA_FOLDER: "./n8n/data"
          N8N_LOCAL_FILES_FOLDER: "./n8n/files"
          FILEBROWSER_ROOT_PATH: "./filebrowser/root"
          FILEBROWSER_DB_FILE_PATH: "./filebrowser/filebrowser.db"
          FILEBROWSER_CONFIG_SETTING_FILE_PATH: "./filebrowser/settings.json"
          TRANSMISSION_CONFIG_SOURCE: "./transmission/config"
          TRANSMISSION_DOWNLOAD_SOURCE: "./transmission/downloads"
          TRANSMISSION_WATCH_SOURCE: "./transmission/watch"
          TRANSMISSION_USERNAME: "dummy"
          TRANSMISSION_PASSWORD: "dummy"
          UPLOAD_LOCATION: "./immich/upload"
          EXTERNAL_LIBRARY_LOCATION: "./immich/external"
          IMMICH_DB_PASSWORD: "dummy"
          IMMICH_DB_USERNAME: "dummy"
          IMMICH_DB_DATABASE_NAME: "immich"
          IMMICH_ML_MODEL_CACHE_LOCATION: "./immich/cache"
          IMMICH_REDIS_DATA_PATH: "./immich/redis"
          IMMICH_DB_DATA_LOCATION: "./immich/postgres"
          SEARXNG_BASE_URL: "http://localhost"
          SEARXNG_SECRET: "dummy"
          SEARXNG_REDIS_URL: "redis://dummy:6379"
          PAISA_DATA_PATH: "./paisa"
          HOMEPAGE_CONFIG_PATH: "./homepage"
          TS_EXTRA_ARGS: ""

      - name: Validate Caddyfile
        run: docker run --rm -v $PWD/Caddyfile:/etc/caddy/Caddyfile caddy:2.10.2 caddy validate --adapter caddyfile --config /etc/caddy/Caddyfile
